#!/bin/sh
# Pre-push hook: Run tests before pushing
# Install with: cp scripts/hooks/pre-push .git/hooks/pre-push && chmod +x .git/hooks/pre-push

# Consume stdin (git passes refs here) to prevent it leaking to subprocesses
cat > /dev/null

echo "Running tests before push..."

# Run tests, capture output
TEST_OUTPUT=$(bun test 2>&1)

# Check for "0 fail" in output (bun test exit code is unreliable due to CLI exit() calls)
if echo "$TEST_OUTPUT" | grep -q " 0 fail"; then
    echo "$TEST_OUTPUT" | tail -3
    exit 0
else
    echo ""
    echo "Tests failed! Push aborted."
    echo ""
    echo "$TEST_OUTPUT" | tail -30
    echo ""
    echo "Run 'bun test' to see full output."
    exit 1
fi
